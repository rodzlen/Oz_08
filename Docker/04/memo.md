# 섹션 5 이미지 빌드

## 이미지 레이어 

이미지 : 컨테이너를 실행하기 위한 읽기 전용 파일
도커 저장소는 저장소를 효율적으로 사용하기 위해  레이어드 시스템으로 이루어져 있음

레이어 - 하나의 층 

모듈화랑 비슷한 개념 

Nginx 이미지 설계
OS -> Nginx 설치 -> Nginx 설정 -> index.html 파일 수정

이미지 레이어와 컨테이너 레이어의 특징

이미지는 os, 설치파일, 설정파일, html 순으로 구성되며 읽기 전용 레이어다.

컨테이너 레이어 실행 시 읽기, 쓰기가 가능한 레이어가 추가된다. (이미지 상단에 추가되어 변경되는 내용을 기록)

컨테이너를 실행하면 새로운 이미지 레이어를 만드는 것이 아니고 읽고 변경된 내용을 기록하는 컨테이너 레이어가 이미지 레이어 위에 추가되는 것 
같은 이미지라면 컨테이너 끼리 공유됨

docker image history 이미지명
이미지 레이어 구성 조회 명령어

copy-on-write : 실행된 컨테이너의 변경된 모든 것들은 이미지 레이어가 아닌 컨테이너 레이어에 저장됨
이미지를 바꾸는 것이 아닌 컨테이너로 카피 후 수정되는 것

immutable layer : 이미지의 각 레이어는 불변됨 한번 생성되면 변경되지 않는다. 이미지의 일관성을 유지, 안전하게 공유

Caching : 레이어를 캐시하여 이미 빌드된 레이어를 재사용함 이미지 빌드 시간을 크게 줄여줌

## 이미지 커밋
### 컨테이너로 커밋
1. 공식 Nginx이미지를 컨테이너로 실행
2. 컨테이너의 내부 파일 변경
3. 커밋기능을 사용하여 새로운 이미지로 저장

docker run -it --name 컨테이너명 이미지명 bin/bash
- 컨테이너 실행과 동시에 터미널 접속 (디버깅하는 용도로 많이 사용)

docler commit -m 커밋명 실행중인컨테이너명 생성할이미지명
- 실행중인 컨테이너를 기존 이미지 레이어에 덮어씌워 새로운 이미지 생성

## 도커파일을 빌드 
iaC Infrasturcture as Code: 인프라 상태를 코드로 관리

iaC 방식은 소스코드를 작성 후 버전관리를 함 명령을 통해 이미지를 생성함 
### 도커파일?
- 이미지를 만드는 단계를 기재한 명세서
docker buid 명령을 통해 이미지를 생성 

docker build 수행단계
1. 임시 컨테이너 생성
2. 변경사항 적용 후 커밋(새로운 레이어 생성)
3. 임시 컨테이너 삭제
4. 반복

명령어 
docker build -t 이미지명 Dockerfile경로

### dockerfile 지시어
FROM 이미지명
- 베이스 이미지를 지정

COPY 파일경로 복사할경로
- 파일을 레이어에 복사

CMD ["명령어"]
- 컨테이너 실행 시 명령어 지정

## 이미지 빌드 - build context
1. 빌드 명령시 도커 데몬에 지정한 폴더 전달
2. 빌드 컨텍스트의 Dockerfile로 빌드 시작, FROM의 베이스 이미지로 임시 컨테이너 생성
3. 베이스 임지로 실행한 임시 컨테이너
4. COPY

.dockerignore 있음 copy 해도 에러남 
### build context란
- Dockerfile이 있는 폴더로 해당 폴더를 이미지로 빌드함 

## Dockerfile 지시어
* 애플리케이션 빌드 - 소스코드를 실행 가능한 프로그램으로 빌드 (라이브러리 및 의존성 설치 등 )
* 애플리케이션 프로그램, 아티팩트 - 애플리케이션 빌드 한 것 
* 이미지로 빌드하는 과정에서 보통은 소스코드를 다운받고 아티팩트로 만드는 과정이 포함됨 

FROM 이미지명

COPY 빌드컨텍스트경로 레이어경로
(cp) 새로운 레이어 추가 

RUN 명령어
새로운 레이어 추가

CMD["명령어"]
레이어 추가 안됨

metadata에만 변경이 있는 건 레이어 추가 안됨

docker build -f 도커파일명 -t 이미지명 Dockerfile경로
목적이 다른 Dockerfile이 있으면 이름을 변경하여 -f옵션으로 파일 지정 가능

## 시스템 관련 Dockerfile 지시어
WORKDIR 폴더명
작업 디렉토리를 지정 ( 새로운 레이어 추가 )

USER 유저명
명령을 실행할 사용자 변경(su) - 새로운 레이어 추가

EXPOSE 포트번호
컨테이너가 사용할 포트를 명시 - 레이어 추가 X

## 환경 변수 지시어
ARG 변수명 변수값
이미지 빌드 시점의 환경 변수 설정 - 컨테이너 실행시 적용 안됨
도커 빌드명령으로 이미지를 빌드 할 때만 사용

ENV 변수명 변수값
이미지 빌드 및 컨테이너 실행 시점의 환경 변수 설정 - 빌드뿐만 아니라이미지를 컨테이너로 실행할 때까지 지속적으로 유지
새로운 레이어 추가

ENTRYPOINT["명령어"]
고정된 명령어 지정

CMD["명령어"]
컨테이너 실행 시 실행 명령어 지정

엔트리 포인트 + CMD 실행됨 무조건! 

## 멀티 스테이지 빌드 
- 도커파일에서 두 개의 베이스 이미지를 활용하는 방법
이미지를 빌드에 사용되는 이미지, 실행에 사용되는 이미지로 나누는 것

* 애플리케이션 빌드 과정
maven , 소스코드 

* 애플리케이션 실행 과정 
java runtime과 jar파일만 있으면 됨

빌드 스테이지, 실행 스테이지로 나누는 것 - 멀티 스테이지 
사용 이유 - 불필요한 의존을 지우면서 효율적으로 공간을 사용할 수 있음
